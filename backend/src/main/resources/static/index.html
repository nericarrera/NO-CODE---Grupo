<!DOCTYPE html>
<html>
<head>
    <title>Chat en tiempo real</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="/webjars/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/2.3.4/stomp.min.js"></script>
</head>
<body class="container mt-4">

<h2 class="mb-4">Chat en tiempo real</h2>

<div class="mb-3">
    <label for="chat_id" class="form-label">ID del canal</label>
    <input type="number" class="form-control" id="chat_id" placeholder="Ej: 1">
</div>

<div class="mb-3">
    <label for="autor_id" class="form-label">Tu ID de usuario</label>
    <input type="number" class="form-control" id="autor_id" placeholder="Ej: 1">
</div>

<div class="mb-3">
    <label for="contenido" class="form-label">Mensaje</label>
    <input type="text" class="form-control" id="contenido" placeholder="Escribí tu mensaje">
</div>

<button class="btn btn-primary" onclick="connectAndSend()">Conectar y Enviar</button>

<hr>

<ul class="list-group" id="chat"></ul>

<script>
    let stompClient;
    let chatId;

    function connectAndSend() {
        chatId = document.getElementById("chat_id").value;
        const autorId = document.getElementById("autor_id").value;
        const contenido = document.getElementById("contenido").value;

        if (!chatId || !autorId || !contenido) {
            alert("Completá todos los campos.");
            return;
        }

        if (!stompClient || !stompClient.connected) {
            let socket = new SockJS('/chat');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function (frame) {
                console.log('Conectado: ' + frame);

                // Suscripción al canal de mensajes
                stompClient.subscribe('/topic/mensajes/' + chatId, function (mensaje) {
                    const msg = JSON.parse(mensaje.body);

                    const li = document.createElement("li");
                    li.className = "list-group-item";
                    li.innerHTML = `<strong>${msg.autor.nombre}:</strong> ${msg.contenido} <small class="text-muted float-end">${msg.timestamp}</small>`;
                    document.getElementById("chat").appendChild(li);
                    li.scrollIntoView({ behavior: 'smooth' });
                });

                // Suscripción al canal de análisis IA (string plano)
                stompClient.subscribe('/topic/analisis/' + chatId, function (sugerencia) {
                    const analisis = sugerencia.body;

                    if (analisis) {
                        const li = document.createElement("li");
                        li.className = "list-group-item list-group-item-info";

                        let html = `<strong>Análisis IA:</strong><br>`;
                        html += `<ul><li>${analisis}</li></ul>`;

                        li.innerHTML = html;
                        document.getElementById("chat").appendChild(li);
                        li.scrollIntoView({ behavior: 'smooth' });
                    }
                });

                sendMessage(autorId, contenido);
            });
        } else {
            sendMessage(autorId, contenido);
        }
    }

    function sendMessage(autorId, contenido) {
        stompClient.send("/app/mensaje", {}, JSON.stringify({
            chatId: parseInt(chatId),
            autorId: parseInt(autorId),
            contenido: contenido
        }));

        document.getElementById("contenido").value = "";
    }
</script>
</body>
</html>
